<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Generatore Database Parole</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #282c34; color: #abb2bf; padding: 2em; line-height: 1.6; }
        h1 { color: #61afef; }
        p { max-width: 800px; }
        #progress-container { margin-top: 2em; font-size: 1.2em; max-width: 800px; }
        #progress-bar-container { width: 100%; background-color: #3e4451; border-radius: 5px; overflow: hidden; margin-top: 1em; border: 1px solid #5c6370; }
        #progress-bar { width: 0%; height: 30px; background-color: #98c379; transition: width 0.3s ease-in-out; text-align: center; line-height: 30px; color: white; font-weight: bold;}
        #log-container { margin-top: 2em; max-width: 800px; }
        #log { height: 300px; overflow-y: scroll; background-color: #21252b; border: 1px solid #3e4451; padding: 1em; border-radius: 5px; font-family: "SF Mono", "Fira Code", "Fira Mono", "Roboto Mono", monospace; font-size: 0.9em; }
        #download-link { display: none; margin-top: 1em; padding: 1em; background-color: #61afef; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <h1>Generatore Database Parole</h1>
    <p>Il processo è iniziato. Per favore, non chiudere questa scheda del browser. L'operazione potrebbe richiedere <strong>circa 15-20 minuti</strong> per essere completata, a seconda della velocità della tua connessione.</p>

    <div id="progress-container">
        <div id="status">Inizializzazione...</div>
        <div id="progress-bar-container">
            <div id="progress-bar">0%</div>
        </div>
    </div>

    <div id="log-container">
        <h3>Log degli eventi:</h3>
        <div id="log"></div>
    </div>
    
    <a id="download-link" href="#" download="database_words_complete.json">Download Completato - Clicca qui se non parte in automatico</a>

    <script type="module">
        // Importa la lista di parole dal tuo progetto
        import { commonWords } from './data/commonWords.js';

        const statusEl = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const logEl = document.getElementById('log');
        const downloadLink = document.getElementById('download-link');

        function log(message) {
            logEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            statusEl.textContent = `Elaborazione parola ${current} di ${total}...`;
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }

        async function generateDatabase() {
            log("Avvio generazione Database...");
            const words = Array.from(commonWords);
            log(`Trovate ${words.length} parole da elaborare.`);

            const results = [];
            const delayMs = 300; // Ritardo per non sovraccaricare le API

            const cleanPhonetic = (raw) => {
                if (!raw) return "";
                return `/${raw.replace(/[/[\\]]/g, '')}/`;
            };

            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                let phonetic = "";
                let translation = "";

                try {
                    // 1. Fetch Fonetica (Dictionary API)
                    const phoneticRes = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                    if (phoneticRes.ok) {
                        const data = await phoneticRes.json();
                        if (Array.isArray(data) && data.length > 0) {
                            const entry = data[0];
                            if (entry.phonetics) {
                                const uk = entry.phonetics.find(p => p.audio && p.audio.includes('uk'));
                                const us = entry.phonetics.find(p => p.audio && p.audio.includes('us'));
                                const generic = entry.phonetics.find(p => p.text);
                                if (uk && uk.text) phonetic = uk.text;
                                else if (us && us.text) phonetic = us.text;
                                else if (generic) phonetic = generic.text;
                            }
                            if (!phonetic && entry.phonetic) phonetic = entry.phonetic;
                        }
                    }

                    // 2. Fetch Traduzione (await gtxRes.json();
                            if (gtxData && gtxData[0] && gtxData[0][0]) translation = gtxData[0][0][0];
                        } else {
                            throw new Error("GTX failed");
                        }
                    } catch (e) {
                        // Fallback MyMemory
                        const transRes = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|it`);
                        if (transRes.ok) {
                            const data = await transRes.json();
                            if (data && data.responseData) translation = data.responseData.translatedText;
                        }
                    }
                } catch (e) {
                    log(`Errore di rete per la parola: ${word}. Procedo con la successiva.`);
                }

                results.push({ text: word, fullPhonetic: cleanPhonetic(phonetic), translation: translation, silentIndexes: [], wordCharPhonetics: null });
                updateProgress(i + 1, words.length);
                await new Promise(r => setTimeout(r, delayMs));
            }

            log("Elaborazione completata. Preparo il file per il download...");
            const jsonString = JSON.stringify(results, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            downloadLink.href = url;
            downloadLink.style.display = 'block';
            downloadLink.click();

            statusEl.textContent = "Completato! Il file è stato scaricato.";
            progressBar.style.backgroundColor = '#61afef';
        }

        generateDatabase().catch(err => {
            log(`ERRORE CRITICO: ${err.message}`);
            statusEl.textContent = "Si è verificato un errore. Controlla il log.";
        });
    </script>
</body>
</html>